<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu-light.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">

<dom-module id="my-language">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
        <h1>Idioma</h1>
        <iron-form id="languageExperience">
            <form>
                <paper-input id="language_name" type="text" name="idioma" label="Idioma" required error-message="Campo requerido" allowed-pattern="[a-zA-Z]"
                    value="{{language.name}}"></paper-input>
                <paper-dropdown-menu-light label="Competencia">
                    <paper-listbox slot="dropdown-content" class="dropdown-content" selected={{level}} attr-for-selected="myvalue" required>
                        <template is="dom-repeat" items="[[levels]]" as="level">
                            <paper-item myvalue="[[level]]">{{level}}</paper-item>
                        </template>
                    </paper-listbox>
                </paper-dropdown-menu-light>
                <input is="iron-input" name="title" type="hidden" value$="[[level]]">
                <paper-button raised on-click="_addLanguage">Agregar</paper-button>
                <paper-button raised on-click="_saveData">Guardar</paper-button>
            </form>
        </iron-form>
        <template is="dom-repeat" items="[[languages]]" as="language">
            <p>{{language.name}} {{language.level}}</p>
            <iron-icon  data-id$="[[index]]" on-click="_removeLanguage" class="item__added" icon="icons:close"></iron-icon>
            <iron-icon data-id$="[[index]]" class="item__added" on-click="_editLanguage" icon="icons:create"></iron-icon>
        </template>
    </template>

    <script>
        /**
         * `my-language`
         *
         * @customElement
         * @polymer
         */
        class MyLanguage extends Polymer.Element {
            static get is() { return 'my-language'; }
            static get properties() {
                return {
                    levels: {
                        type: Array,
                        value: ['Principiante', 'Intermedio', 'Avanzado', 'Nativo']
                    },
                    languages: {
                        type: Array,
                        value: []
                    },
                    level: {
                        type: Number,
                        value: 0,
                        notify: true
                    }
                };
            }

            connectedCallback() {
                super.connectedCallback();
            }

            _saveData(event) {
                if (this.languages.length > 0) {
                    localStorage.setItem('languages', JSON.stringify(this.languages));
                    this._dispatchEvent('languages-saved', this.languages);
                    console.info('Data saved!');
                }
            }

            _addLanguage(event) {
                if (this._validateForm()) {
                    const newLanguage = { name: this.$.language_name.value, level: this.level };
                    console.log(newLanguage);
                    this.push('languages', newLanguage);
                    this.resetForm();
                }
            }

            resetForm() {
                this.level = 'Principiante';
                this.$.language_name.value = null;
            }

            _validateForm() {
                return this.$.languageExperience.validate();
            }

            _removeLanguage(e) {
                const id = e.target.getAttribute('id');
                this.splice('languages', id, 1);
            }

            _editLanguage(e) {
                const id = e.target.getAttribute('data-id');
                this.level = this.languages[id].level;
                this.$.language_name.value = this.languages[id].name;
                this.splice('languages', id, 1);
            }

            _dispatchEvent(event, detail, bubbles = true) {
                this.dispatchEvent(new CustomEvent(event, {
                bubbles: bubbles,
                composed: true,
                detail: {
                    key: 'languages',
                    data: detail
                }
                }));
            }
        }

        window.customElements.define(MyLanguage.is, MyLanguage);
    </script>
</dom-module>